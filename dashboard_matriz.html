<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BZ55 · Red de Franquicias · Vista Matriz</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
/**
 * ═══════════════════════════════════════════════════════════════
 *  BZ55 FITNESS CONCEPT · CONFIGURACIÓN CENTRAL
 *  Este archivo se define UNA SOLA VEZ y no se toca más
 *  salvo que cambien las reglas de negocio o se añada un centro
 * ═══════════════════════════════════════════════════════════════
 */

const BZ55_CONFIG = {

  // ─────────────────────────────────────────────────────────────
  //  CENTROS DE LA RED
  //  Añade un nuevo objeto aquí cuando se incorpore un centro
  // ─────────────────────────────────────────────────────────────
  centros: [
    {
      id: 'JR',
      nombre: 'Julián Romea',
      ciudad: 'Madrid',
      color: '#6c63ff',
      objetivo_clientes: 150,
      estado: 'estable',           // 'estable' | 'rescate' | 'nuevo'
      apertura: 'Octubre 2024',
      destinatarios: {
        email: '',                 // ej: 'propietario@jr.com'
        whatsapp: '',              // ej: '+34600000000'
      },
    },
    {
      id: 'LDH',
      nombre: 'López de Hoyos',
      ciudad: 'Madrid',
      color: '#f5c842',
      objetivo_clientes: 150,
      estado: 'rescate',
      apertura: 'Noviembre 2025',
      destinatarios: {
        email: '',
        whatsapp: '',
      },
    },
    // Descomenta y rellena cuando se añada el próximo centro:
    // {
    //   id: 'C3',
    //   nombre: 'Nombre Centro',
    //   ciudad: 'Ciudad',
    //   color: '#00e8a2',
    //   objetivo_clientes: 150,
    //   estado: 'nuevo',
    //   apertura: 'Mes Año',
    //   destinatarios: { email: '', whatsapp: '' },
    // },
  ],

  // ─────────────────────────────────────────────────────────────
  //  COLUMNAS DEL EXCEL
  //  Si el ERP cambia algún nombre de columna, solo toca aquí
  // ─────────────────────────────────────────────────────────────
  columnas: {
    cliente_id:     'Cliente (ID)',
    servicio:       'Elemento2',
    importe:        'Total sin IVA',
    anyo:           'Año',
    mes:            'Mes',
    factura_fecha:  'Factura',
    centro_id:      null,   // Si el Excel lleva columna de centro, ponla aquí
  },

  // ─────────────────────────────────────────────────────────────
  //  SERVICIOS VÁLIDOS PARA CLIENTES ACTIVOS Y CUOTA MEDIA
  //  También son la base para calcular altas y bajas
  // ─────────────────────────────────────────────────────────────
  servicios_validos: new Set([
    '1 SESIÓN SEMANA - S.GENERAL',
    '1 SESIÓN SEMANA FOUNDERS',
    '2 SESIONES SEMANA - S.GENERAL',
    '2 SESIONES SEMANA FOUNDERS',
    '3 SESIONES SEMANA - S.GENERAL',
    '3 SESIONES SEMANA FOUNDERS',
    'BONO 4 SESIONES - S.GENERAL',
    'BONO 4 SESIONES FOUNDERS',
    'BONO 8 SESIONES FOUNDERS',
    'SESIÓN INDIVIDUAL 1:1',
    '1 SESIÓN SEMANAL / MES',
    '1 SESIÓN SEMANAL / MES ANIVERSARIO',
    '1 SESIÓN SEMANAL / MES FOUNDERS',
    '2 SESIONES SEMANALES / MES',
    '2 SESIONES SEMANALES / MES ANIVERSARIO',
    '2 SESIONES SEMANALES / MES FOUNDERS',
    '3 SESIONES SEMANALES / MES',
    '3 SESIONES SEMANALES / MES ANIVERSARIO',
    '3 SESIONES SEMANALES / MES FOUNDERS',
    'BONO 2 SESIONES',
    'BONO 4 SESIONES',
    'BONO 4 SESIONES / MES',
    'BONO 4 SESIONES / MES ANIVERSARIO',
    'BONO 4 SESIONES / MES FOUNDERS',
    'BONO 8 SESIONES',
    'BONO 8 SESIONES / MES',
    'BONO 8 SESIONES / MES ANIVERSARIO',
    'BONO 8 SESIONES / MES FOUNDERS',
    'E.P. 2:1 BONO 12 SESIONES (CADUCIDAD: 2 MESES)',
    'E.P. 2:1 BONO 4 SESIONES (CADUCIDAD: 1 MES)',
    'E.P. 2:1 BONO 8 SESIONES (CADUCIDAD: 2 MESES)',
    'EVERY DAY / (1 DIARIA)',
    'EVERY DAY / (1 DIARIA) ANIVERSARIO',
    'EVERY DAY / (1 DIARIA) FOUNDERS',
    'TARIFA ANIVERSARIO',
    'TARIFAS FOUNDERS',
  ]),

  // ─────────────────────────────────────────────────────────────
  //  SESIONES DE PRUEBA
  //  Cuentan para ratio de cierre pero NO como clientes activos
  // ─────────────────────────────────────────────────────────────
  servicios_prueba: new Set([
    'SESIÓN DE PRUEBA',
    '1 SESIÓN DE PRUEBA',
  ]),

  // ─────────────────────────────────────────────────────────────
  //  SERVICIOS EXCLUIDOS DE CLIENTES
  //  Solo cuentan para facturación total
  // ─────────────────────────────────────────────────────────────
  servicios_excluidos: new Set([
    'CALCETINES ANTIDESLIZANTES 36-41',
    'CALCETINES ANTIDESLIZANTES BZ55 GRISES',
    'SESIÓN INDIVIDUAL GRUPO',
    '1 SESIÓN INDIVIDUAL EN GRUPO',
    'ALQUILER TOALLA DUCHA',
    'BOTELLA ALUMINIO AZUL',
    'BOTELLA ALUMINIO FUCSIA',
    'BOTELLA ALUMINIO PLATA',
    'CAJA REGALO',
    'CALCETINES ANTIDESLIZANTES 41-46',
    'CALCETINES ANTIDESLIZANTES BZ55 - BLANCO',
    'CALCETINES ANTIDESLIZANTES BZ55 - GRIS',
    'GRUPOS REDUCIDOS',
    'SESIÓN PAREJA ENTRENO PERSONAL',
    'SUMMER PACK',
    'TOTE BAG',
  ]),

  // ─────────────────────────────────────────────────────────────
  //  NOMBRES DE MESES EN ESPAÑOL
  // ─────────────────────────────────────────────────────────────
  meses: ['','Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
};

</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@300;400;600;800&family=Epilogue:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');

:root {
  --bg:      #07070f;
  --bg2:     #0d0d1a;
  --card:    #10101e;
  --border:  #1c1c32;
  --border2: #28284a;
  --accent:  #6c63ff;
  --green:   #00e8a2;
  --gold:    #f5c842;
  --red:     #ff4f6e;
  --blue:    #3db8ff;
  --text:    #eeeef5;
  --muted:   #5a5a80;
  --muted2:  #3a3a58;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  background: var(--bg); color: var(--text);
  font-family: 'Epilogue', sans-serif; min-height: 100vh; overflow-x: hidden;
}
body::before {
  content: ''; position: fixed; inset: 0;
  background-image:
    linear-gradient(rgba(108,99,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(108,99,255,0.03) 1px, transparent 1px);
  background-size: 48px 48px; pointer-events: none; z-index: 0;
}
body::after {
  content: ''; position: fixed; top: -40%; left: -20%; width: 80%; height: 80%;
  background: radial-gradient(ellipse, rgba(108,99,255,0.06) 0%, transparent 65%);
  pointer-events: none; z-index: 0;
}

/* ── Header ── */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(7,7,15,0.94); backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  padding: 0 40px; height: 64px;
  display: flex; align-items: center; justify-content: space-between;
}
.logo { font-family: 'Unbounded', sans-serif; font-weight: 800; font-size: 1.3rem; letter-spacing: -0.02em; }
.logo span { color: var(--accent); }
.logo-div { width: 1px; height: 28px; background: var(--border2); }
.logo-sub { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--muted); letter-spacing: 0.18em; text-transform: uppercase; line-height: 1.4; }
.header-right { display: flex; align-items: center; gap: 16px; }
.net-badge {
  display: flex; align-items: center; gap: 8px;
  border: 1px solid var(--border2); padding: 5px 14px;
  font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--muted);
  letter-spacing: 0.12em; text-transform: uppercase;
}
.net-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: blink 2s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

/* ── Tabs ── */
.nav-tabs {
  display: flex; align-items: center; gap: 2px; padding: 0 40px;
  background: var(--bg2); border-bottom: 1px solid var(--border);
  overflow-x: auto; position: sticky; top: 64px; z-index: 190;
}
.nav-tab {
  display: flex; align-items: center; gap: 8px; padding: 14px 22px;
  font-family: 'Epilogue', sans-serif; font-size: 0.78rem; font-weight: 500; color: var(--muted);
  cursor: pointer; border: none; border-bottom: 2px solid transparent;
  background: none; white-space: nowrap; transition: all 0.15s; user-select: none;
}
.nav-tab:hover { color: var(--text); }
.nav-tab.active { color: var(--text); border-bottom-color: var(--tab-c, var(--accent)); }
.tab-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--tab-c, var(--accent)); flex-shrink: 0; }

/* ── Views ── */
main { position: relative; z-index: 1; padding: 36px 40px 60px; max-width: 1440px; margin: 0 auto; }
.view { display: none; }
.view.active { display: block; }

/* ── No data ── */
.no-data-banner {
  background: rgba(245,200,66,0.06); border: 1px solid rgba(245,200,66,0.2);
  padding: 14px 20px; margin-bottom: 24px;
  font-family: 'JetBrains Mono', monospace; font-size: 0.68rem; color: var(--gold);
  display: flex; align-items: center; gap: 12px;
}

/* ── Section label ── */
.section-label {
  font-family: 'JetBrains Mono', monospace; font-size: 0.6rem;
  letter-spacing: 0.25em; text-transform: uppercase; color: var(--muted);
  margin-bottom: 16px; padding-bottom: 10px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 10px;
}
.section-label::before { content: ''; display: block; width: 16px; height: 1px; background: var(--accent); }

/* ── Summary strip ── */
.strip {
  display: grid; grid-template-columns: repeat(5, 1fr);
  gap: 1px; background: var(--border); border: 1px solid var(--border);
  margin-bottom: 32px;
}
.strip-item { background: var(--card); padding: 22px 20px; }
.strip-label { font-family: 'JetBrains Mono', monospace; font-size: 0.56rem; letter-spacing: 0.18em; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
.strip-val { font-family: 'Unbounded', sans-serif; font-size: 1.7rem; font-weight: 600; line-height: 1; letter-spacing: -0.03em; }
.strip-val .u { font-size: 0.85rem; font-weight: 300; color: var(--muted); }
.strip-delta { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; margin-top: 6px; }
.up{color:var(--green)} .down{color:var(--red)} .neu{color:var(--blue)}

/* ── Center cards ── */
.centers-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px; margin-bottom: 32px; }
.center-card { background: var(--card); border: 1px solid var(--border); overflow: hidden; }
.center-header {
  padding: 16px 22px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  background: rgba(255,255,255,0.015);
}
.center-name { font-family: 'Unbounded', sans-serif; font-size: 0.85rem; font-weight: 600; letter-spacing: -0.01em; }
.center-meta { font-family: 'JetBrains Mono', monospace; font-size: 0.55rem; color: var(--muted); margin-top: 3px; letter-spacing: 0.1em; }
.pill { display: inline-flex; align-items: center; gap: 5px; font-family: 'JetBrains Mono', monospace; font-size: 0.56rem; letter-spacing: 0.1em; text-transform: uppercase; padding: 4px 10px; border-radius: 2px; }
.pill-green { background: rgba(0,232,162,.1); color: var(--green); }
.pill-red   { background: rgba(255,79,110,.1);  color: var(--red); }
.pill-gold  { background: rgba(245,200,66,.1);  color: var(--gold); }
.center-body { padding: 18px 22px; }
.center-kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
.mini-kpi { padding: 12px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); }
.mini-label { font-family: 'JetBrains Mono', monospace; font-size: 0.53rem; letter-spacing: 0.14em; text-transform: uppercase; color: var(--muted); margin-bottom: 7px; }
.mini-val { font-family: 'Unbounded', sans-serif; font-size: 1.25rem; font-weight: 600; line-height: 1; letter-spacing: -0.02em; }
.mini-delta { font-family: 'JetBrains Mono', monospace; font-size: 0.56rem; margin-top: 5px; }
.center-tag { font-family: 'JetBrains Mono', monospace; font-size: 0.55rem; padding: 4px 10px; border: 1px solid; letter-spacing: 0.1em; text-transform: uppercase; }
.progress-row { display: flex; align-items: center; gap: 10px; margin-bottom: 7px; }
.prog-label { font-family: 'JetBrains Mono', monospace; font-size: 0.56rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; width: 100px; flex-shrink: 0; }
.prog-track { flex: 1; height: 4px; background: var(--border2); border-radius: 1px; overflow: hidden; }
.prog-fill  { height: 100%; border-radius: 1px; }
.prog-pct   { font-family: 'JetBrains Mono', monospace; font-size: 0.58rem; width: 32px; text-align: right; }

/* ── Charts ── */
.chart-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.chart-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 32px; }
.chart-card { background: var(--card); border: 1px solid var(--border); padding: 24px; }
.chart-title { font-family: 'Unbounded', sans-serif; font-size: 0.72rem; font-weight: 600; letter-spacing: -0.01em; margin-bottom: 4px; }
.chart-sub { font-family: 'JetBrains Mono', monospace; font-size: 0.58rem; color: var(--muted); margin-bottom: 20px; }
.chart-wrap { width: 100%; }
.chart-wrap canvas { display: block; width: 100% !important; }

/* ── Ranking ── */
.rank-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 32px; }
.rank-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.rank-label { font-size: 0.72rem; width: 180px; flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.rank-track { flex: 1; height: 4px; background: var(--border2); border-radius: 1px; overflow: hidden; }
.rank-fill  { height: 100%; border-radius: 1px; }
.rank-num   { font-family: 'JetBrains Mono', monospace; font-size: 0.63rem; color: var(--muted); width: 50px; text-align: right; }

/* ── Footer ── */
footer {
  position: relative; z-index: 1; padding: 20px 40px; border-top: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  font-family: 'JetBrains Mono', monospace; font-size: 0.56rem; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase;
}

/* ── Responsive ── */
@media (max-width: 1100px) { .strip { grid-template-columns: repeat(3,1fr); } .chart-grid-3 { grid-template-columns: 1fr 1fr; } }
@media (max-width: 800px) {
  header,main,footer { padding-left: 16px; padding-right: 16px; }
  .nav-tabs { padding: 0 16px; }
  .strip, .rank-grid { grid-template-columns: 1fr 1fr; }
  .chart-grid-2,.chart-grid-3 { grid-template-columns: 1fr; }
  footer { flex-direction: column; gap: 8px; }
  .logo-sub { display: none; }
}
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:14px">
    <div class="logo">BZ<span>55</span></div>
    <div class="logo-div"></div>
    <div class="logo-sub">Red de Franquicias<br>Vista Matriz</div>
  </div>
  <div class="header-right">
    <div class="net-badge" id="netBadge"><span class="net-dot"></span><span id="netCount">Cargando...</span></div>
    <span style="font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--muted)" id="updateLabel"></span>
  </div>
</header>

<nav class="nav-tabs" id="navTabs">
  <button class="nav-tab active" style="--tab-c:var(--accent)" onclick="switchView('resumen',this)">
    <span class="tab-dot"></span>Red completa
  </button>
  <!-- Center tabs generated dynamically -->
</nav>

<main>
  <!-- ── VIEW: RED COMPLETA ── -->
  <div id="view-resumen" class="view active">

    <div id="noDataMsg" style="display:none">
      <div class="no-data-banner">⚠ &nbsp; Aún no se han cargado datos. Ve a <a href="procesar.html" style="color:var(--gold);margin-left:4px">procesar.html</a> para subir los Excel de cada centro.</div>
    </div>

    <p class="section-label" id="redLabel">Resumen de red</p>
    <div class="strip" id="summaryStrip">
      <div class="strip-item"><div class="strip-label">Centros activos</div><div class="strip-val" id="sCentros">—</div></div>
      <div class="strip-item"><div class="strip-label">Clientes totales red</div><div class="strip-val" id="sClientes">—</div><div class="strip-delta" id="sClientesDelta"></div></div>
      <div class="strip-item"><div class="strip-label">Facturación red</div><div class="strip-val" id="sFact">—</div><div class="strip-delta" id="sFactDelta"></div></div>
      <div class="strip-item"><div class="strip-label">Ticket medio red</div><div class="strip-val" id="sTicket">—</div><div class="strip-delta" id="sTicketDelta"></div></div>
      <div class="strip-item"><div class="strip-label">Balance neto red</div><div class="strip-val" id="sBalance">—</div><div class="strip-delta" id="sBalanceSub"></div></div>
    </div>

    <p class="section-label">Estado por centro · Último mes</p>
    <div class="centers-row" id="centersRow"></div>

    <p class="section-label">Comparativa · Meses coincidentes</p>
    <div class="chart-grid-2" style="margin-bottom:20px">
      <div class="chart-card"><div class="chart-title">Clientes activos por centro</div><div class="chart-sub">Evolución mensual comparada</div><div class="chart-wrap"><canvas id="cmpClientes"></canvas></div></div>
      <div class="chart-card"><div class="chart-title">Facturación cuotas por centro</div><div class="chart-sub">Euros sin IVA</div><div class="chart-wrap"><canvas id="cmpFact"></canvas></div></div>
    </div>
    <div class="chart-grid-3">
      <div class="chart-card"><div class="chart-title">Ticket medio comparado</div><div class="chart-sub">€ / cliente activo</div><div class="chart-wrap"><canvas id="cmpTicket"></canvas></div></div>
      <div class="chart-card"><div class="chart-title">Altas por centro</div><div class="chart-sub">Meses coincidentes</div><div class="chart-wrap"><canvas id="cmpAltas"></canvas></div></div>
      <div class="chart-card"><div class="chart-title">Balance neto por centro</div><div class="chart-sub">Altas – Bajas</div><div class="chart-wrap"><canvas id="cmpBalance"></canvas></div></div>
    </div>

    <p class="section-label">Ranking de centros · Último mes</p>
    <div class="rank-grid" id="rankGrid"></div>

  </div><!-- /view-resumen -->

  <!-- Center views generated dynamically -->
</main>

<footer>
  <span>ASESFIT × BZ55 Fitness Concept · Dashboard Red Franquicias · Confidencial</span>
  <span id="footerDate">Vista Matriz</span>
</footer>

<script>
// ─────────────────────────────────────────────────────
//  LOAD ALL CENTERS DATA FROM LOCALSTORAGE
// ─────────────────────────────────────────────────────
const allData = {}; // centroId → payload.meses array

BZ55_CONFIG.centros.forEach(c => {
  const raw = localStorage.getItem(`bz55_datos_${c.id}`);
  if (raw) {
    try { allData[c.id] = JSON.parse(raw).meses; } catch(e) {}
  }
});

const loadedCentros = BZ55_CONFIG.centros.filter(c => allData[c.id]);
const totalCentros  = loadedCentros.length;

// Update header
document.getElementById('netCount').textContent = `${totalCentros} centro${totalCentros !== 1 ? 's' : ''} activo${totalCentros !== 1 ? 's' : ''}`;
document.getElementById('updateLabel').textContent = `Actualizado ${new Date().toLocaleDateString('es-ES')}`;
document.getElementById('footerDate').textContent = `Vista Matriz · ${new Date().toLocaleDateString('es-ES',{month:'long',year:'numeric'})}`;

if (totalCentros === 0) {
  document.getElementById('noDataMsg').style.display = 'block';
}

// ─────────────────────────────────────────────────────
//  BUILD NAV TABS + CENTER VIEWS DYNAMICALLY
// ─────────────────────────────────────────────────────
const navTabs = document.getElementById('navTabs');
const mainEl  = document.querySelector('main');

BZ55_CONFIG.centros.forEach(c => {
  // Tab
  const btn = document.createElement('button');
  btn.className = 'nav-tab';
  btn.style.setProperty('--tab-c', c.color);
  btn.innerHTML = `<span class="tab-dot" style="background:${c.color}"></span>${c.nombre}`;
  if (!allData[c.id]) btn.innerHTML += ` <span style="font-family:'JetBrains Mono',monospace;font-size:0.5rem;padding:2px 6px;background:var(--border2);color:var(--muted);border-radius:2px">Sin datos</span>`;
  btn.onclick = () => switchView(`centro-${c.id}`, btn);
  navTabs.appendChild(btn);

  // View container
  const view = document.createElement('div');
  view.id = `view-centro-${c.id}`;
  view.className = 'view';
  view.innerHTML = buildCentroView(c);
  mainEl.appendChild(view);
});

// ─────────────────────────────────────────────────────
//  POPULATE RESUMEN VIEW
// ─────────────────────────────────────────────────────
if (totalCentros > 0) {
  // Compute network totals for last month
  const lastMeses = loadedCentros.map(c => {
    const m = allData[c.id];
    return { centro: c, last: m[m.length-1], prev: m.length > 1 ? m[m.length-2] : null };
  });

  const totClientes = lastMeses.reduce((s,x) => s + x.last.clientes, 0);
  const prevClientes = lastMeses.every(x => x.prev) ? lastMeses.reduce((s,x) => s + x.prev.clientes, 0) : null;
  const totFact   = lastMeses.reduce((s,x) => s + x.last.fact_cuotas, 0);
  const prevFact  = lastMeses.every(x => x.prev) ? lastMeses.reduce((s,x) => s + x.prev.fact_cuotas, 0) : null;
  const totAltas  = lastMeses.reduce((s,x) => s + x.last.altas, 0);
  const totBajas  = lastMeses.reduce((s,x) => s + x.last.bajas, 0);
  const totTicket = totClientes > 0 ? (totFact / totClientes) : 0;
  const prevTicket= prevClientes ? (prevFact / prevClientes) : null;

  document.getElementById('sCentros').textContent  = totalCentros;
  document.getElementById('sClientes').innerHTML   = totClientes;
  document.getElementById('sClientesDelta').innerHTML = prevClientes != null ? deltaHTML(totClientes, prevClientes, '') : '';
  document.getElementById('sFact').innerHTML       = `${Math.round(totFact).toLocaleString('es-ES')}<span class="u">€</span>`;
  document.getElementById('sFactDelta').innerHTML  = prevFact != null ? deltaHTML(totFact, prevFact, '%', true) : '';
  document.getElementById('sTicket').innerHTML     = `${totTicket.toFixed(2).replace('.',',')}<span class="u">€</span>`;
  document.getElementById('sTicketDelta').innerHTML= prevTicket != null ? deltaHTML(totTicket, prevTicket, '€') : '';
  const bal = totAltas - totBajas;
  document.getElementById('sBalance').innerHTML    = `<span class="${bal>=0?'up':'down'}">${bal>=0?'+':''}${bal}</span>`;
  document.getElementById('sBalanceSub').innerHTML = `<span class="up">▲ ${totAltas}</span> altas · <span class="down">▼ ${totBajas}</span> bajas`;

  document.getElementById('redLabel').textContent = `Resumen de red · ${lastMeses[0].last.label}`;

  // Center cards
  const centersRow = document.getElementById('centersRow');
  lastMeses.forEach(({ centro: c, last, prev }) => {
    const pct = Math.min(100, Math.round((last.clientes / c.objetivo_clientes) * 100));
    const estado = c.estado === 'rescate' ? '<span class="pill pill-red">● Rescate</span>' : c.estado === 'nuevo' ? '<span class="pill pill-gold">● Nuevo</span>' : '<span class="pill pill-green">● Estable</span>';
    const card = document.createElement('div');
    card.className = 'center-card';
    card.innerHTML = `
      <div class="center-header">
        <div>
          <div class="center-name">${c.nombre}</div>
          <div class="center-meta">${c.ciudad.toUpperCase()} · ACTIVO DESDE ${c.apertura.toUpperCase()}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          ${estado}
          <span class="center-tag" style="color:${c.color};border-color:${c.color}">${c.id}</span>
        </div>
      </div>
      <div class="center-body">
        <div class="center-kpis">
          <div class="mini-kpi">
            <div class="mini-label">Clientes</div>
            <div class="mini-val" style="color:${c.color}">${last.clientes}</div>
            <div class="mini-delta ${last.clientes >= (prev?.clientes||0) ? 'up' : 'down'}">${last.clientes >= (prev?.clientes||0) ? '▲' : '▼'} ${prev ? Math.abs(last.clientes - prev.clientes) + ' vs ant.' : 'primer mes'}</div>
          </div>
          <div class="mini-kpi">
            <div class="mini-label">Facturación</div>
            <div class="mini-val" style="color:${c.color};font-size:1rem">${Math.round(last.fact_cuotas).toLocaleString('es-ES')}€</div>
            <div class="mini-delta ${last.fact_cuotas >= (prev?.fact_cuotas||0) ? 'up' : 'down'}">${prev ? (((last.fact_cuotas-prev.fact_cuotas)/prev.fact_cuotas)*100).toFixed(1) + '%' : '—'}</div>
          </div>
          <div class="mini-kpi">
            <div class="mini-label">Ticket</div>
            <div class="mini-val" style="color:${c.color};font-size:1rem">${last.ticket.toFixed(2).replace('.',',')}€</div>
            <div class="mini-delta ${last.ticket >= (prev?.ticket||0) ? 'up' : 'down'}">${prev ? (last.ticket >= prev.ticket ? '▲' : '▼') + ' ' + Math.abs(last.ticket - prev.ticket).toFixed(2) + '€' : '—'}</div>
          </div>
        </div>
        <div class="progress-row">
          <div class="prog-label">Objetivo ${c.objetivo_clientes}</div>
          <div class="prog-track"><div class="prog-fill" style="width:${pct}%;background:${c.color}"></div></div>
          <div class="prog-pct neu">${pct}%</div>
        </div>
        <div class="progress-row">
          <div class="prog-label">Altas</div>
          <div class="prog-track"><div class="prog-fill" style="width:${Math.min(100,(last.altas/(Math.max(1,...lastMeses.map(x=>x.last.altas))))*100)}%;background:var(--green)"></div></div>
          <div class="prog-pct up">+${last.altas}</div>
        </div>
        <div class="progress-row">
          <div class="prog-label">Bajas</div>
          <div class="prog-track"><div class="prog-fill" style="width:${Math.min(100,(last.bajas/(Math.max(1,...lastMeses.map(x=>x.last.bajas))))*100)}%;background:var(--red)"></div></div>
          <div class="prog-pct down">-${last.bajas}</div>
        </div>
      </div>`;
    centersRow.appendChild(card);
  });

  // Comparative charts — common months
  buildComparativeCharts(loadedCentros);

  // Rankings
  buildRankings(lastMeses);
}

// ─────────────────────────────────────────────────────
//  COMPARATIVE CHARTS
// ─────────────────────────────────────────────────────
function buildComparativeCharts(centros) {
  // Find common month labels
  const allMonthSets = centros.map(c => new Set(allData[c.id].map(m => m.label)));
  const allLabels    = allData[centros[0].id].map(m => m.label);
  const commonLabels = allLabels.filter(l => allMonthSets.every(s => s.has(l)));

  if (commonLabels.length === 0) return;

  const chartOpts = (ar=2.2) => ({
    responsive: true, maintainAspectRatio: true, aspectRatio: ar,
    plugins: {
      legend: { labels: { color: '#5a5a80', font: { family: 'JetBrains Mono', size: 9 }, boxWidth: 10 } },
      tooltip: { backgroundColor: '#10101e', borderColor: '#28284a', borderWidth: 1, titleColor: '#5a5a80', bodyColor: '#eeeef5', titleFont: { family: 'JetBrains Mono', size: 9 }, bodyFont: { family: 'JetBrains Mono', size: 10 } }
    },
    scales: {
      x: { ticks: { color: '#3a3a58', font: { family: 'JetBrains Mono', size: 8 }, maxRotation: 40 }, grid: { color: 'rgba(255,255,255,0.03)' } },
      y: { ticks: { color: '#3a3a58', font: { family: 'JetBrains Mono', size: 8 } }, grid: { color: 'rgba(255,255,255,0.03)' } }
    }
  });

  const datasets = (field, alpha='99') => centros.map(c => ({
    label: c.nombre,
    data: commonLabels.map(l => {
      const m = allData[c.id].find(x => x.label === l);
      return m ? m[field] : null;
    }),
    borderColor: c.color, backgroundColor: c.color + alpha,
    tension: 0.3, pointRadius: 3, borderWidth: 2, fill: field === 'clientes',
  }));

  new Chart(document.getElementById('cmpClientes'), {
    type: 'line', data: { labels: commonLabels, datasets: datasets('clientes','18') }, options: chartOpts(2.2)
  });
  new Chart(document.getElementById('cmpFact'), {
    type: 'bar', data: { labels: commonLabels, datasets: centros.map(c => ({
      label: c.nombre,
      data: commonLabels.map(l => allData[c.id].find(x=>x.label===l)?.fact_cuotas || null),
      backgroundColor: c.color + 'aa', borderRadius: 3,
    }))}, options: chartOpts(2.2)
  });
  new Chart(document.getElementById('cmpTicket'), {
    type: 'line', data: { labels: commonLabels, datasets: centros.map(c => ({
      label: c.nombre,
      data: commonLabels.map(l => allData[c.id].find(x=>x.label===l)?.ticket || null),
      borderColor: c.color, tension: 0.3, pointRadius: 4, borderWidth: 2,
    }))}, options: chartOpts(2)
  });
  new Chart(document.getElementById('cmpAltas'), {
    type: 'bar', data: { labels: commonLabels, datasets: centros.map(c => ({
      label: c.nombre,
      data: commonLabels.map(l => allData[c.id].find(x=>x.label===l)?.altas || null),
      backgroundColor: c.color + 'aa', borderRadius: 2,
    }))}, options: chartOpts(2)
  });
  new Chart(document.getElementById('cmpBalance'), {
    type: 'bar', data: { labels: commonLabels, datasets: centros.map(c => ({
      label: c.nombre,
      data: commonLabels.map(l => { const m = allData[c.id].find(x=>x.label===l); return m ? m.altas-m.bajas : null; }),
      backgroundColor: commonLabels.map(l => {
        const m = allData[c.id]?.find(x=>x.label===l);
        return m ? (m.altas-m.bajas >= 0 ? c.color+'aa' : '#ff4f6e88') : 'transparent';
      }),
      borderRadius: 2,
    }))}, options: chartOpts(2)
  });
}

// ─────────────────────────────────────────────────────
//  RANKINGS
// ─────────────────────────────────────────────────────
function buildRankings(lastMeses) {
  const grid = document.getElementById('rankGrid');
  const metrics = [
    { label: 'Clientes activos', field: 'clientes', suffix: '' },
    { label: 'Facturación cuotas', field: 'fact_cuotas', suffix: '€' },
    { label: 'Ticket medio', field: 'ticket', suffix: '€' },
    { label: 'Balance neto', field: x => x.altas - x.bajas, suffix: '' },
  ];

  metrics.forEach(({ label, field, suffix }) => {
    const sorted = [...lastMeses].sort((a,b) => {
      const va = typeof field === 'function' ? field(a.last) : a.last[field];
      const vb = typeof field === 'function' ? field(b.last) : b.last[field];
      return vb - va;
    });
    const maxVal = Math.abs(typeof field === 'function' ? field(sorted[0].last) : sorted[0].last[field]) || 1;

    const card = document.createElement('div');
    card.className = 'chart-card';
    card.innerHTML = `<div class="chart-title">${label}</div><div class="chart-sub" style="margin-bottom:16px">Último mes disponible</div>`;

    sorted.forEach(({ centro: c, last }) => {
      const val = typeof field === 'function' ? field(last) : last[field];
      const pct = Math.max(0, Math.min(100, (Math.abs(val) / maxVal) * 100));
      const fmtVal = typeof val === 'number' && val % 1 !== 0 ? val.toFixed(2) : val;
      const row = document.createElement('div');
      row.className = 'rank-row';
      row.innerHTML = `
        <div class="rank-label">${c.nombre}</div>
        <div class="rank-track"><div class="rank-fill" style="width:${pct}%;background:${val >= 0 ? c.color : 'var(--red)'}"></div></div>
        <div class="rank-num ${val > 0 ? 'up' : val < 0 ? 'down' : 'neu'}">${val > 0 && field !== 'clientes' && field !== 'ticket' && field !== 'fact_cuotas' ? '+' : ''}${fmtVal}${suffix}</div>`;
      card.appendChild(row);
    });
    grid.appendChild(card);
  });
}

// ─────────────────────────────────────────────────────
//  BUILD INDIVIDUAL CENTER VIEW HTML
// ─────────────────────────────────────────────────────
function buildCentroView(c) {
  const meses = allData[c.id];
  if (!meses) {
    return `<div class="no-data-banner">⚠ Sin datos para ${c.nombre}. Ve a <a href="procesar.html" style="color:var(--gold)">procesar.html</a> para subir el Excel de este centro.</div>`;
  }
  const last = meses[meses.length - 1];
  const prev = meses.length > 1 ? meses[meses.length - 2] : null;
  const pct  = Math.min(100, Math.round((last.clientes / c.objetivo_clientes) * 100));
  const bal  = last.altas - last.bajas;

  // Build table rows
  const tableRows = [...meses].reverse().map(m => {
    const b = m.altas - m.bajas; const bc = b>0?'up':b<0?'down':'';
    return `<tr>
      <td>${m.label}</td><td class="neu">${m.clientes}</td>
      <td>${m.fact_total.toLocaleString('es-ES',{maximumFractionDigits:0})}€</td>
      <td>${m.fact_cuotas.toLocaleString('es-ES',{maximumFractionDigits:0})}€</td>
      <td>${m.ticket.toFixed(2)}€</td>
      <td class="up">${m.altas||'—'}</td><td class="down">${m.bajas||'—'}</td>
      <td class="${bc}">${b>0?'+':''}${b}</td><td class="neu">${m.pruebas}</td>
    </tr>`;
  }).join('');

  return `
    <div style="display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:28px;padding-bottom:20px;border-bottom:1px solid var(--border)">
      <div>
        <div style="font-family:'Unbounded',sans-serif;font-size:2rem;font-weight:800;letter-spacing:-0.04em;line-height:1;color:${c.color}">${c.nombre}</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:0.62rem;color:var(--muted);margin-top:6px;letter-spacing:0.1em">${c.ciudad} · Activo desde ${c.apertura} · ${meses.length} meses de datos</div>
      </div>
      <a href="dashboard_${c.id.toLowerCase()}.html" style="padding:10px 18px;background:${c.color};color:white;text-decoration:none;font-family:'Epilogue',sans-serif;font-size:0.75rem;font-weight:600">Ver dashboard completo →</a>
    </div>

    ${c.estado==='rescate'?`<div class="no-data-banner" style="background:rgba(255,79,110,.06);border-color:rgba(255,79,110,.3);color:var(--red);margin-bottom:20px">⚠ &nbsp; Programa de rescate activo · ${c.objetivo_clientes - last.clientes} clientes para el objetivo</div>`:''}

    <div class="chart-card" style="margin-bottom:24px">
      <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:12px">
        <span style="font-family:'Unbounded',sans-serif;font-size:0.85rem;font-weight:600">Progreso hacia objetivo · ${c.objetivo_clientes} clientes</span>
        <span style="font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--muted)">${last.label}</span>
      </div>
      <div style="height:8px;background:var(--border2);border-radius:1px;overflow:hidden;margin-bottom:8px">
        <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,${c.color},${c.color}bb);border-radius:1px"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--muted)">
        <span>0</span><span style="color:${c.color}">Actual: ${last.clientes} (${pct}%)</span><span>Meta: ${c.objetivo_clientes}</span>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:14px">
      ${kpiCardHTML('Clientes', last.clientes, c.color, prev ? `${last.clientes>=prev.clientes?'▲ +':'▼ -'}${Math.abs(last.clientes-prev.clientes)} vs ant.` : '', last.clientes>=prev?.clientes)}
      ${kpiCardHTML('Fact. Cuotas', last.fact_cuotas.toLocaleString('es-ES',{maximumFractionDigits:0})+'€', 'var(--green)', prev?deltaPctStr(last.fact_cuotas,prev.fact_cuotas):'', last.fact_cuotas>=(prev?.fact_cuotas||0))}
      ${kpiCardHTML('Fact. Total',  last.fact_total.toLocaleString('es-ES',{maximumFractionDigits:0})+'€',  'var(--blue)', '', true)}
      ${kpiCardHTML('Ticket Medio', last.ticket.toFixed(2)+'€', 'var(--gold)', prev?`${last.ticket>=prev.ticket?'▲':'▼'} ${Math.abs(last.ticket-prev.ticket).toFixed(2)}€`:'', last.ticket>=(prev?.ticket||0))}
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:32px">
      ${kpiCardHTML('Altas', last.altas, 'var(--green)', prev?`${last.altas>=prev.altas?'▲ +':'▼ '}${Math.abs(last.altas-prev.altas)} vs ant.`:'', last.altas>=(prev?.altas||0))}
      ${kpiCardHTML('Bajas', last.bajas, 'var(--red)', prev?`${last.bajas<=prev.bajas?'▼ menos ':'▲ +'}${Math.abs(last.bajas-prev.bajas)}`:'' , last.bajas<=(prev?.bajas||999))}
      ${kpiCardHTML('Balance', (bal>=0?'+':'')+bal, bal>=0?'var(--green)':'var(--red)', '', bal>=0)}
      ${kpiCardHTML('Sesiones prueba', last.pruebas, 'var(--gold)', '', true)}
    </div>

    <p class="section-label">Evolución mensual</p>
    <div class="chart-grid-2" style="margin-bottom:20px">
      <div class="chart-card"><div class="chart-title">Clientes activos</div><div class="chart-sub">Con servicio válido</div><div class="chart-wrap"><canvas id="c-${c.id}-clientes"></canvas></div></div>
      <div class="chart-card"><div class="chart-title">Facturación</div><div class="chart-sub">Total vs Cuotas · €</div><div class="chart-wrap"><canvas id="c-${c.id}-fact"></canvas></div></div>
    </div>
    <div class="chart-grid-3" style="margin-bottom:32px">
      <div class="chart-card"><div class="chart-title">Ticket medio</div><div class="chart-sub">€ / cliente activo</div><div class="chart-wrap"><canvas id="c-${c.id}-ticket"></canvas></div></div>
      <div class="chart-card"><div class="chart-title">Altas vs Bajas</div><div class="chart-sub">Movimiento mensual</div><div class="chart-wrap"><canvas id="c-${c.id}-mov"></canvas></div></div>
      <div class="chart-card"><div class="chart-title">Balance neto</div><div class="chart-sub">Altas – Bajas</div><div class="chart-wrap"><canvas id="c-${c.id}-balance"></canvas></div></div>
    </div>

    <p class="section-label">Histórico mensual</p>
    <div class="table-wrap" style="margin-bottom:32px">
      <table>
        <thead><tr><th>Mes</th><th>Clientes</th><th>Fact.Total €</th><th>Fact.Cuotas €</th><th>Ticket €</th><th>Altas</th><th>Bajas</th><th>Balance</th><th>Pruebas</th></tr></thead>
        <tbody>${tableRows}</tbody>
      </table>
    </div>`;
}

function kpiCardHTML(label, val, color, delta, isGood) {
  const deltaClass = isGood ? 'up' : 'down';
  return `<div class="strip-item" style="position:relative;overflow:hidden">
    <div style="position:absolute;top:0;left:0;right:0;height:2px;background:${color}"></div>
    <div class="strip-label">${label}</div>
    <div class="strip-val" style="color:${color};font-size:1.5rem">${val}</div>
    ${delta ? `<div class="strip-delta ${deltaClass}">${delta}</div>` : ''}
  </div>`;
}

function deltaPctStr(cur, prev) {
  if (!prev) return '';
  const pct = ((cur-prev)/prev*100).toFixed(1);
  return `${cur>=prev?'▲ +':'▼ '}${pct}%`;
}

// ─────────────────────────────────────────────────────
//  TAB SWITCHING — lazy chart init
// ─────────────────────────────────────────────────────
const chartsBuilt = {};

function switchView(id, btn) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('view-' + id).classList.add('active');
  btn.classList.add('active');

  if (!chartsBuilt[id] && id.startsWith('centro-')) {
    chartsBuilt[id] = true;
    const cid = id.replace('centro-', '');
    const c   = BZ55_CONFIG.centros.find(x => x.id === cid);
    if (c && allData[cid]) buildCentroCharts(c, allData[cid]);
  }
}

function buildCentroCharts(c, meses) {
  const labels = meses.map(m => m.label);
  const co = { responsive:true, maintainAspectRatio:true, aspectRatio:2.2, plugins:{ legend:{ labels:{ color:'#5a5a80', font:{ family:'JetBrains Mono', size:9 }, boxWidth:10 } }, tooltip:{ backgroundColor:'#10101e', borderColor:'#28284a', borderWidth:1, titleColor:'#5a5a80', bodyColor:'#eeeef5', titleFont:{family:'JetBrains Mono',size:9}, bodyFont:{family:'JetBrains Mono',size:10} } }, scales:{ x:{ ticks:{ color:'#3a3a58', font:{family:'JetBrains Mono',size:8}, maxRotation:40 }, grid:{color:'rgba(255,255,255,0.03)'} }, y:{ ticks:{ color:'#3a3a58', font:{family:'JetBrains Mono',size:8} }, grid:{color:'rgba(255,255,255,0.03)'} } } };
  const co2 = { ...co, aspectRatio:2 };
  const OBJ = c.objetivo_clientes;

  new Chart(document.getElementById(`c-${c.id}-clientes`), { type:'bar', data:{ labels, datasets:[
    { label:'Clientes', data:meses.map(m=>m.clientes), backgroundColor:meses.map(m=>m.clientes>=OBJ?'var(--green)':c.color+'99'), borderRadius:3 },
    { label:`Obj.${OBJ}`, data:Array(labels.length).fill(OBJ), type:'line', borderColor:'var(--red)', borderDash:[6,4], borderWidth:1.5, pointRadius:0, fill:false },
  ]}, options:co });

  new Chart(document.getElementById(`c-${c.id}-fact`), { type:'line', data:{ labels, datasets:[
    { label:'Total',  data:meses.map(m=>m.fact_total),  borderColor:'var(--blue)', backgroundColor:'rgba(61,184,255,0.06)', tension:0.3, pointRadius:3, borderWidth:2, fill:true },
    { label:'Cuotas', data:meses.map(m=>m.fact_cuotas), borderColor:c.color, backgroundColor:c.color+'12', tension:0.3, pointRadius:3, borderWidth:2, fill:true },
  ]}, options:co });

  new Chart(document.getElementById(`c-${c.id}-ticket`), { type:'line', data:{ labels, datasets:[
    { label:'Ticket', data:meses.map(m=>m.ticket), borderColor:'var(--gold)', tension:0.3, pointRadius:4, borderWidth:2 },
  ]}, options:co2 });

  new Chart(document.getElementById(`c-${c.id}-mov`), { type:'bar', data:{ labels, datasets:[
    { label:'Altas', data:meses.map(m=>m.altas), backgroundColor:'rgba(0,232,162,0.7)', borderRadius:2 },
    { label:'Bajas', data:meses.map(m=>m.bajas), backgroundColor:'rgba(255,79,110,0.7)', borderRadius:2 },
  ]}, options:co2 });

  new Chart(document.getElementById(`c-${c.id}-balance`), { type:'bar', data:{ labels, datasets:[{
    label:'Balance', data:meses.map(m=>m.altas-m.bajas),
    backgroundColor:meses.map(m=>m.altas-m.bajas>=0?'rgba(0,232,162,0.7)':'rgba(255,79,110,0.7)'), borderRadius:2,
  }]}, options:co2 });
}

// ─────────────────────────────────────────────────────
//  HELPERS
// ─────────────────────────────────────────────────────
function deltaHTML(cur, prev, suffix, isPct=false) {
  if (prev == null) return '';
  let diff, sign, cls;
  if (isPct) {
    diff = ((cur-prev)/prev*100).toFixed(1);
    sign = cur >= prev ? '▲ +' : '▼ ';
  } else {
    diff = (cur-prev).toLocaleString('es-ES',{maximumFractionDigits:0});
    sign = cur >= prev ? '▲ +' : '▼ ';
    diff = Math.abs(cur-prev).toLocaleString('es-ES',{maximumFractionDigits:0});
  }
  cls = cur >= prev ? 'up' : 'down';
  return `<span class="${cls}">${sign}${diff}${suffix} vs ant.</span>`;
}
</script>
</body>
</html>
